#!/bin/bash

validate_bash() {
	echo "$1" | bash -n > /dev/null 2>&1
	return $?
}

validate_json() {
	echo "$1" | jq . > /dev/null 2>&1
	return $?
}

validate_python() {
	echo "$1" | python3 -m py_compile > /dev/null 2>&1
	return $?
}

process_md_files() {
	directory=$1

	if [[ ! -d "$directory" ]]; then
		echo "Error: Directory $directory does not exist."
		exit 1
	fi

	for md_file in "$directory"/*.md; do
		echo "Processing file: $md_file"

		code_blocks=$(grep -Pzo '```.*\n(.*?)```' "$md_file" | sed 's/```.*//g' | tr -d '\0')

		while read -r code_block; do
			if [[ "$code_block" =~ ^\s*bash\s*$ ]]; then
				if validate_bash "$code_block"; then
					echo "Valid Bash code block found in $md_file"
				else
					echo "Invalid Bash code block in $md_file"
				fi
			elif echo "$code_block" | jq . > /dev/null 2>&1; then
				if validate_json "$code_block"; then
					echo "Valid JSON block found in $md_file"
				else
					echo "Invalid JSON block in $md_file"
				fi
			elif echo "$code_block" | python3 -m py_compile > /dev/null 2>&1; then
				if validate_python "$code_block"; then
					echo "Valid Python block found in $md_file"
				else
					echo "Invalid Python block in $md_file"
				fi
			else
				echo "Unknown code block found in $md_file"
			fi
		done <<< "$code_blocks"
	done
}

if [[ -z "$1" ]]; then
	echo "Usage: $0 <directory>"
	exit 1
fi

process_md_files "$1"
