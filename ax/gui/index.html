<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>OmniOpt2 GUI</title>
		<style>
			.color_red {
			color: red;
			}

			.color_orange {
				color: orange;
			}

			#config_table > tbody > tr:nth-child(odd) {
				background-color: #ffffff;
			}

			#config_table > tbody > tr:nth-child(even) {
				background-color: #cfcfcf;
			}
		</style>
		<script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
		<script>
			var initialized = false;

			var l = console.log;
			var log = console.log;

			var tableData = [
				{ label: "Experiment name", id: "experiment_name", type: "text", value: "", placeholder: "Name of your experiment (only letters)" },
				{ label: "Memory (in GB)", id: "mem_gb", type: "number", value: 1, placeholder: "Memory in GB per worker", min: 0 },
				{ label: "Timeout for the main program", id: "time", type: "number", value: 60, placeholder: "Timeout for the whole program (minutes)", min: 1 },
				{ label: "Timeout for a single worker", id: "worker_timeout", type: "number", value: 60, placeholder: "Timeout for a single worker (minutes)", min: 1 },
				{ label: "Maximal number of evaluations", id: "max_eval", type: "number", value: 500, placeholder: "Maximum number of evaluations", min: 1 },
				{ label: "Number of maximum parallel evaluations", id: "num_parallel_jobs", type: "number", value: 500, placeholder: "Maximum number of parallel evaluations", min: 0 },
				{ label: "GPUs", id: "gpus", type: "number", value: 0, placeholder: "Number of GPUs", min: 0 },
				{ label: "Follow", id: "follow", type: "checkbox", value: 1 },
				{ label: "Verbose", id: "verbose", type: "checkbox", value: 0 },
				{ label: "Debug", id: "debug", type: "checkbox", value: 0 },
				{ label: "Maximize?", id: "maximize", type: "checkbox", value: 0 },
				{ label: "Run program", id: "run_program", type: "text", value: "", placeholder: "Your program with parameters" }
			];


			function update_command() {
				var errors = [];
				var warnings = [];
				var command = "./main";

				tableData.forEach(function(item) {
					var value = $("#" + item.id).val();
					if (item.type === "checkbox") {
						value = $("#" + item.id).is(":checked") ? "1" : "0";
						if (value === "1") {
							command += " --" + item.id;
						}
					} else if (item.type === "text" && value === "") {
						errors.push("Field '" + item.label + "' is required.");
					} else if (item.type === "number") {
						var numValue = parseFloat(value);
						if (isNaN(numValue)) {
							errors.push("Invalid value for '" + item.label + "'. Must be a number.");
						} else if (item.min && item.max && (numValue < item.min || numValue > item.max)) {
							errors.push("Value for '" + item.label + "' must be between " + item.min + " and " + item.max + ".");
						} else if (item.min && (numValue < item.min)) {
							errors.push("Value for '" + item.label + "' must be larger than " + item.min + ".");
						} else if (item.max && (numValue > item.max)) {
							errors.push("Value for '" + item.label + "' must be smaller than" + item.max + ".");
						} else {
							value = numValue.toString();
							command += " --" + item.id + "='" + value + "'";
						}
					} else {
						command += " --" + item.id + "='" + value + "'";
					}
				});

				var parameters = [];

				var i = 0;
				var parameter_names = [];

				$(".configRow").each(function() {
					var option = $(this).find(".optionSelect").val();
					var parameterName = $(this).find(".parameterName").val().trim();
					var value;

					if(parameter_names.includes(parameterName)) {
						errors.push(`Parameter name "${parameterName}" already exists. Can only be defined once!`)	
					} else if(parameterName) {
						if (option === "range") {
							var minValue = parseFloat($(this).find(".minValue").val());
							var maxValue = parseFloat($(this).find(".maxValue").val());
							var numberType = $("#numberTypeSelect").val();

							if (minValue >= maxValue) {
								errors.push("Invalid range for parameter " + parameterName + ". The minimum value must be less than the maximum value.");
							} else if (minValue === maxValue) {
								warnings.push("Warning: The minimum and maximum values for parameter " + parameterName + " are equal.");
							}

							var is_ok = true;

							if(isNaN(minValue)) {
								errors.push("minValue for parameter " + parameterName + " is not a number")
								is_ok = false;
							}

							if(isNaN(maxValue)) {
								errors.push("maxValue for parameter " + parameterName + " is not a number");
								is_ok = false;
							}

							if(is_ok) {
								value = `${parameterName} range ${minValue} ${maxValue} ${numberType}`;
							}
						} else if (option === "choice") {
							var choiceValues = $(this).find(".choiceValues").val();
							value = `${parameterName} choice ${choiceValues}`;
						} else if (option === "fixed") {
							var fixedValue = $(this).find(".fixedValue").val();
							value = `${parameterName} fixed ${fixedValue}`;
						}

						if (parameterName && value) {
							parameters.push(value);
							parameter_names.push(parameterName);
						}
					} else {
						warnings.push("Parameter nr. " + i + " has no name. Ignoring it.");
					}

					i++;
				});

				if (parameters.length > 0) {
					command += " --parameter " + parameters.join(" --parameter ");
				}

				if (errors.length) {
					$("#command").html("<span class='color_red'>" + errors.join("<br>") + "</span>");
				} else {
					$("#command").text(command);
				}

				if (warnings.length) {
					$("#warnings").html("<span class='color_orange'>" + warnings.join("<br>") + "</span>").show();
				} else {
					$("#warnings").html("").hide();
				}

				updateUrl

(); // Update URL mit den aktuellen Parametern
			}

			function updateOptions(select) {
				var selectedOption = select.value;
				var valueCell = select.parentNode.nextSibling;
				if (selectedOption === 'range') {
					valueCell.innerHTML = `<table>
					<tr>
					    <td>
						Name:
					    </td>
					    <td>
						<input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='text' class='parameterName'>
					    </td>
					</tr>
					<tr>
					    <td>
						Min:
					    </td>
					    <td>
						<input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='number' class='minValue'>
					    </td>
					</tr>
					<tr>
					    <td>
						Max:
					    </td>
					    <td>
						<input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='number' class='maxValue'>
					    </td>
					</tr>
					<tr>
					    <td>
						Type:
					    </td>
					    <td>
						<select  onchange="update_command()" onkeyup="update_command()" onclick="update_command()" id="numberTypeSelect">
							<option value="float">Float</option>
							<option value="int">Integer</option>
						</select>
					    </td>
					</tr>
				    </table>`;
				} else if (selectedOption === 'choice') {
					valueCell.innerHTML = `<table>
						<tr>
						    <td>
							Name:
						    </td>
						    <td>
							<input  onchange="update_command()" onkeyup="update_command()" onclick="update_command()" type='text' class='parameterName'>
						    </td>
						</tr>
						<tr>
							<td>Values (comma separated):</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='text' class='choiceValues'></td>
						</tr>
					</table>`;
				} else if (selectedOption === 'fixed') {
					valueCell.innerHTML = `<table>
						<tr>
						    <td>
							Name:
						    </td>
						    <td>
							<input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='text' class='parameterName'>
						    </td>
						</tr>
						<tr>
							<td>Value:</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='text' class='fixedValue'></td>
						</tr>
					</table>`;
				}
			}

			function addRow(button) {
				// Funktion zum Hinzufügen einer neuen Zeile
				var table = document.getElementById("config_table");
				var rowIndex = button.parentNode.parentNode.rowIndex; // Index der aktuellen Zeile
				var newRow = table.insertRow(rowIndex + 1); // Neue Zeile nach der aktuellen einfügen

				// Neue Zellen für die Zeile erstellen
				var optionCell = newRow.insertCell(0);
				var valueCell = newRow.insertCell(1);
				var buttonCell = newRow.insertCell(2);

				// Inhalt der Zellen setzen
				optionCell.innerHTML = "<select onchange='updateOptions(this)' class='optionSelect'><option value='range'>Range</option><option value='choice'>Choice</option><option value='fixed'>Fixed</option></select>";
				valueCell.innerHTML = ""; // Leerer Platz für die Optionen

				buttonCell.innerHTML = "<button onclick='removeRow(this)'>-</button>"; // Minus-Button für die neue Zeile
				button.parentNode.innerHTML = "<button onclick='addRow(this)'>+</button>"; // Plus-Button in der aktuellen Zeile entfernen

				updateOptions(optionCell.firstChild); // Direkt die Optionen aktualisieren

				// Klassen hinzufügen
				newRow.classList.add('configRow');
				optionCell.firstChild.classList.add('optionSelect');
				valueCell.firstChild.classList.add('valueInput');

				update_command(); // Befehl aktualisieren
			}

			function removeRow(button) {
				// Funktion zum Entfernen der aktuellen Zeile
				var table = document.getElementById("config_table");
				var rowIndex = button.parentNode.parentNode.rowIndex; // Index der aktuellen Zeile
				var rowCount = table.rows.length;
				if (rowCount > 2) { // Stellen Sie sicher, dass mindestens eine Zeile unentfernbar ist
					table.deleteRow(rowIndex); // Aktuelle Zeile entfernen
					updateButtons(); // Plus- und Minus-Buttons aktualisieren
					update_command(); // Befehl aktualisieren
				}
			}

			function updateButtons() {
				// Funktion zum Aktualisieren der Plus- und Minus-Buttons in jeder Zeile
				var table = document.getElementById("config_table");
				var rows = table.rows;
				for (var i = 1; i < rows.length - 1; i++) {
					if (rows[i].cells.length >= 3) { // Überprüfen, ob die Zeile mindestens drei Zellen hat
						rows[i].cells[2].innerHTML = "<button onclick='removeRow(this)'>-</button>"; // Minus-Button
					}
				}
				rows[rows.length - 1].cells[2].innerHTML = "<button onclick='addRow(this)'>+</button>"; // Plus-Button
			}

			// Funktion zum Erstellen der Tabelle basierend auf den Daten
			function createTable() {
				var table = $("#config_table");
				var tbody = table.find("tbody");

				tableData.forEach(function(item) {
					var row = $("<tr>");
					var labelCell = $("<td>").text(item.label);
					var valueCell = $("<td>").attr("colspan", "2");

					var input = $("<input>").attr({ id: item.id, type: item.type, value: item.value, placeholder: item.placeholder, min: item.min, max: item.max });

					if (item.type === "checkbox") {
						input.prop("checked", item.value);
					}

					input.on({
						change: update_command,
						keyup: update_command,
						click: update_command
					});

					valueCell.append(input);
					row.append(labelCell, valueCell);
					tbody.append(row);
				});

				// Plus-Button hinzufügen
				tbody.append("<tr><td colspan='3'><button onclick='addRow(this)' id='add_row_button'>+</button></td></tr>");
			}

			// Funktion zum Aktualisieren des Befehls
			function updateUrl() {
				var params = [];
				tableData.forEach(function(item) {
					params.push(item.id + "=" + $("#" + item.id).val());
				});

				var parameterIndex = 0;
				$(".configRow").each(function() {
					var option = $(this).find(".optionSelect").val();
					var parameterName = $(this).find(".parameterName").val();

					if (parameterName) {
						if (option === "range") {
							var minValue = $(this).find(".minValue").val();
							var maxValue = $(this).find(".maxValue").val();
							var numberType = $(this).find(".numberTypeSelect").val();

							params.push("parameter_" + parameterIndex + "_name=" + parameterName);
							params.push("parameter_" + parameterIndex + "_type=" + option);
							params.push("parameter_" + parameterIndex + "_min=" + minValue);
							params.push("parameter_" + parameterIndex + "_max=" + maxValue);
							params.push("parameter_" + parameterIndex + "_number_type=" + numberType);
						} else if (option === "choice") {
							var choiceValues = $(this).find(".choiceValues").val();

							params.push("parameter_" + parameterIndex + "_name=" + parameterName);
							params.push("parameter_" + parameterIndex + "_type=" + option);
							params.push("parameter_" + parameterIndex + "_values=" + choiceValues);
						} else if (option === "fixed") {
							var fixedValue = $(this).find(".fixedValue").val();

							params.push("parameter_" + parameterIndex + "_name=" + parameterName);
							params.push("parameter_" + parameterIndex + "_type=" + option);
							params.push("parameter_" + parameterIndex + "_value=" + fixedValue);
						}
					}
					parameterIndex++;
				});

				if (initialized) {
					var url = window.location.origin + window.location.pathname + "?" + params.join("&");
					window.history.replaceState(null, null, url);
				}
			}


			$(document).ready(function() {
				createTable();

				var urlParams = new URLSearchParams(window.location.search);
				tableData.forEach(function(item) {
					var paramValue = urlParams.get(item.id);
					if (paramValue !== null) {
						$("#" + item.id).val(paramValue).trigger('change');
					}
				});

				var parameterIndex = 0;
				$(".configRow").each(function(index) {
					var parameterName = urlParams.get("parameter_" + parameterIndex + "_name");
					var option = urlParams.get("parameter_" + parameterIndex + "_type");

					if (parameterName && option) {
						$(this).find(".parameterName").val(parameterName);
						$(this).find(".optionSelect").val(option).trigger('change');
						if (option === 'range') {
							$(this).find(".minValue").val(urlParams.get("parameter_" + parameterIndex + "_min"));
							$(this).find(".maxValue").val(urlParams.get("parameter_" + parameterIndex + "_max"));
							$(this).find(".numberTypeSelect").val(urlParams.get("parameter_" + parameterIndex + "_number_type"));
						} else if (option === 'choice') {
							$(this).find(".choiceValues").val(urlParams.get("parameter_" + parameterIndex + "_values"));
						} else if (option === 'fixed') {
							$(this).find(".fixedValue").val(urlParams.get("parameter_" + parameterIndex + "_value"));
						}
					}
					parameterIndex++;
				});

				$("#add_row_button").click();
				update_command();

				initialized = true;
			});
		</script>
	</head>
	<body>
		<table>
			<tr>
				<td>
					<table id="config_table" border="1">
						<thead>
							<tr>
								<th>Option</th>
								<th colspan="2">Value</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</td>
				<td>
					<code id="command"></code>
					<div id="warnings" style="display: none"></div>
				</td>
			</tr>
		</table>
	</body>
</html>
