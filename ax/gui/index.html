<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>OmniOpt2 GUI</title>
		<style>
			.color_red {
				color: red;
			}

			.color_orange {
				color: orange;
			}

			#config_table > tbody > tr:nth-child(odd) {
				background-color: #ffffff;
			}

			#config_table > tbody > tr:nth-child(even) {
				background-color: #cfcfcf;
			}

			.error_element {
				background-color: red;
			}

			button {
				border-radius: 10px;
				text-align: center;
			}

			.add_parameter {
				background-color: #90ee90;
			}

			.remove_parameter {
				background-color: #f1807e;
			}

			.half_width_td {
				width: 50%;
			}
		</style>
		<script src="jquery-3.7.1.js"></script>
		<script>
			var initialized = false;
			var shown_operation_insecure_without_server = false;

			var l = console.log;
			var log = console.log;

			var tableData = [
				{ label: "Partition", id: "partition", type: "select", value: "", options: [] },
				{ label: "Experiment name", id: "experiment_name", type: "text", value: "", placeholder: "Name of your experiment (only letters)" },
				{ label: "Memory (in GB)", id: "mem_gb", type: "number", value: 1, placeholder: "Memory in GB per worker", min: 0 },
				{ label: "Timeout for the main program", id: "time", type: "number", value: 60, placeholder: "Timeout for the whole program (minutes)", min: 1 },
				{ label: "Timeout for a single worker", id: "worker_timeout", type: "number", value: 60, placeholder: "Timeout for a single worker (minutes)", min: 1 },
				{ label: "Maximal number of evaluations", id: "max_eval", type: "number", value: 500, placeholder: "Maximum number of evaluations", min: 1 },
				{ label: "Number of maximum parallel evaluations", id: "num_parallel_jobs", type: "number", value: 500, placeholder: "Maximum number of parallel evaluations", min: 0 },
				{ label: "GPUs", id: "gpus", type: "number", value: 0, placeholder: "Number of GPUs", min: 0 },
				{ label: "Follow", id: "follow", type: "checkbox", value: 1 },
				{ label: "Verbose", id: "verbose", type: "checkbox", value: 0 },
				{ label: "Debug", id: "debug", type: "checkbox", value: 0 },
				{ label: "Maximize?", id: "maximize", type: "checkbox", value: 0 },
				{ label: "Run program", id: "run_program", type: "text", value: "", placeholder: "Your program with parameters" }
			];

			var partition_data = {
				"ml": {
					"number_of_workers": 180,
					"computation_time": 168,
					"max_number_of_gpus": 6,
					"max_mem_per_core": 63500,
					"mem_per_cpu": 63500,
					"name": "ml (Machine Learning, ppc64le)",
					"warning": "It is not recommended to use the /scratch or /lustre-filesystem on the ML partition",
					"link": "https://doc.zih.tu-dresden.de/jobs_and_resources/hardware_overview/#ibm-power9-nodes-for-machine-learning"
				},
				"alpha": {
					"number_of_workers": 160,
					"computation_time": 168,
					"max_number_of_gpus": 8,
					"max_mem_per_core": 49500,
					"mem_per_cpu": 49500,
					"name": "alpha (Alpha Centauri, amd64)",
					"warning": "",
					"link": "https://doc.zih.tu-dresden.de/jobs_and_resources/alpha_centauri/"
				},
				"barnard": {
					"number_of_workers": 10,
					"computation_time": 10,
					"max_number_of_gpus": 0,
					"max_mem_per_core": 10000,
					"mem_per_cpu": 1000,
					"name": "Barnard",
					"warning": "",
					"link": "https://doc.zih.tu-dresden.de/jobs_and_resources/hardware_overview/#island-4-to-6-intel-haswell-cpus"
				},
				"romeo": {
					"number_of_workers": 192,
					"computation_time": 168,
					"max_number_of_gpus": 0,
					"max_mem_per_core": 10000,
					"mem_per_cpu": 256000,
					"name": "Romeo",
					"warning": "",
					"link": "https://doc.zih.tu-dresden.de/jobs_and_resources/hardware_overview/#romeo"
				}
			};


			function updatePartitionOptions() {
				var partitionSelect = $("#partition");
				partitionSelect.empty();

				$.each(partition_data, function(key, value) {
					partitionSelect.append($("<option></option>")
						.attr("value", key)
						.text(value.name));
				});

				partitionSelect.on("change", function() {
					var partition = $(this).val();
					var partitionInfo = partition_data[partition];

					if (partitionInfo) {
						$("#mem_gb").val(Math.floor(partitionInfo.max_mem_per_core / 1000));
						$("#time").val(partitionInfo.computation_time);
						$("#worker_timeout").val(partitionInfo.computation_time);
						$("#max_eval").val(partitionInfo.number_of_workers);
						$("#num_parallel_jobs").val(partitionInfo.number_of_workers);
						$("#gpus").val(partitionInfo.max_number_of_gpus);
					}
				});
			}

			function update_command() {
				var errors = [];
				var warnings = [];
				var command = "./main";

				tableData.forEach(function(item) {
					var value = $("#" + item.id).val();
					if (item.type === "checkbox") {
						value = $("#" + item.id).is(":checked") ? "1" : "0";
						if (value === "1") {
							command += " --" + item.id;
						}
					} else if (item.type === "text" && value === "") {
						var this_error = "Field '" + item.label + "' is required.";
						$("#" + item.id + "_error").html(this_error).show();
						$("#" + item.id).css("background-color", "red");

						errors.push(this_error);
					} else if (item.type === "number") {
						var numValue = parseFloat(value);
						if (isNaN(numValue)) {
							errors.push("Invalid value for '" + item.label + "'. Must be a number.");
						} else if (item.min && item.max && (numValue < item.min || numValue > item.max)) {
							errors.push("Value for '" + item.label + "' must be between " + item.min + " and " + item.max + ".");
						} else if (item.min && (numValue < item.min)) {
							errors.push("Value for '" + item.label + "' must be larger than " + item.min + ".");
						} else if (item.max && (numValue > item.max)) {
							errors.push("Value for '" + item.label + "' must be smaller than" + item.max + ".");
						} else {
							value = numValue.toString();
							if (item.type == "number") {
								command += " --" + item.id + " " + value;
							} else {
								command += " --" + item.id + " '" + value + "'";
							}
						}
					} else {
						command += " --" + item.id + " '" + value + "'";
						$("#" + item.id + "_error").html("").hide();
						$("#" + item.id).css("background-color", "");
					}
				});

				var parameters = [];

				var i = 0;
				var parameter_names = [];

				$(".parameterRow").each(function() {
					var option = $(this).find(".optionSelect").val();
					var parameterName = $(this).find(".parameterName").val().trim();
					var _value;

					var warn_msg = "";

					if(parameter_names.includes(parameterName)) {
						var err_msg = `Parameter name "${parameterName}" already exists. Can only be defined once!`;
						warn_msg += err_msg;

						$($(".parameterRow")[i]).css("background-color", "red")
					} else if(parameterName) {
						if (option === "range") {
							var minValue = parseFloat($(this).find(".minValue").val());
							var maxValue = parseFloat($(this).find(".maxValue").val());

							var numberType = $("#numberTypeSelect").val();

							if (minValue === maxValue) {
								warn_msg += "Warning: The minimum and maximum values for parameter " + parameterName + " are equal.<br>";
							}

							var is_ok = true;

							if(isNaN(minValue)) {
								warn_msg += "minValue for parameter " + parameterName + " is not a number.<br>";
								is_ok = false;
							}

							if(isNaN(maxValue)) {
								warn_msg += "maxValue for parameter " + parameterName + " is not a number.<br>";
								is_ok = false;
							}

							if(is_ok) {
								_value = `${parameterName} range ${minValue} ${maxValue} ${numberType}`;
							}
						} else if (option === "choice") {
							var choiceValues = $(this).find(".choiceValues").val();
							_value = `${parameterName} choice ${choiceValues}`;
						} else if (option === "fixed") {
							var fixedValue = $(this).find(".fixedValue").val();
							_value = `${parameterName} fixed ${fixedValue}`;
						}

						if (parameterName && _value) {
							parameters.push(_value);
							parameter_names.push(parameterName);

							$($(".parameterRow")[i]).css("background-color", "")
						} else {
							if(!parameterName) {
								warn_msg += "No parameter name<br>";
							}

							$($(".parameterRow")[i]).css("background-color", "orange")
						}
					} else {
						warn_msg += "Name is missing.<br>"

						$($(".parameterRow")[i]).css("background-color", "orange")
					}


					if(warn_msg) {
						$($(".parameterError")[i]).html(warn_msg).show();
					} else {
						$($(".parameterError")[i]).html("").hide();
					}

					i++;
				});

				if (parameters.length > 0) {
					command += " --parameter " + parameters.join(" --parameter ");
				}

				if (!errors.length) {
					$("#command").text(command);
				}

				updateUrl();
			}

			function updateOptions(select) {
				var selectedOption = select.value;
				var valueCell = select.parentNode.nextSibling;
				var paramName = $(select).parent().parent().find(".parameterName").val();

				if(paramName === undefined) {
					paramName = "";
				}


				if (selectedOption === 'range') {
					valueCell.innerHTML = `<table>
						<tr>
							<td>Name:</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()" value="${paramName}" type='text' class='parameterName'></td>
						</tr>
						<tr>
							<td>Min:</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='number' class='minValue'></td>
						</tr>
						<tr>
							<td>Max:</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='number' class='maxValue'></td>
						</tr>
						<tr>
							<td>Type:</td>
							<td>
								<select  onchange="update_command()" onkeyup="update_command()" onclick="update_command()" id="numberTypeSelect">
									<option value="float">Float</option>
									<option value="int">Integer</option>
								</select>
							</td>
						</tr>
				    </table>`;
				} else if (selectedOption === 'choice') {
					valueCell.innerHTML = `<table>
						<tr>
							<td>Name:</td>
							<td><input  onchange="update_command()" onkeyup="update_command()" onclick="update_command()" value="${paramName}" type='text' class='parameterName'></td>
						</tr>
						<tr>
							<td>Values (comma separated):</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='text' class='choiceValues'></td>
						</tr>
					</table>`;
				} else if (selectedOption === 'fixed') {
					valueCell.innerHTML = `<table>
						<tr>
							<td>Name:</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()" value="${paramName}"  type='text' class='parameterName'></td>
						</tr>
						<tr>
							<td>Value:</td>
							<td><input onchange="update_command()" onkeyup="update_command()" onclick="update_command()"  type='text' class='fixedValue'></td>
						</tr>
					</table>`;
				}

				valueCell.innerHTML += "<div style='display: none' class='error_element parameterError'></div>"
			}

			function addRow(button) {
				var table = document.getElementById("config_table");
				var rowIndex = button.parentNode.parentNode.rowIndex;
				var numberOfParams = $(".parameterRow").length;
				var newRow = table.insertRow(rowIndex + numberOfParams + 1);

				var optionCell = newRow.insertCell(0);
				var valueCell = newRow.insertCell(1);
				var buttonCell = newRow.insertCell(2);

				optionCell.innerHTML = "<select onchange='updateOptions(this)' class='optionSelect'><option value='range'>Range</option><option value='choice'>Choice</option><option value='fixed'>Fixed</option></select>";
				valueCell.innerHTML = "";

				buttonCell.innerHTML = "<button class='remove_parameter' onclick='removeRow(this)'>Remove</button>";

				updateOptions(optionCell.firstChild);

				newRow.classList.add('parameterRow');
				optionCell.firstChild.classList.add('optionSelect');
				valueCell.firstChild.classList.add('valueInput');

				update_command();
			}

			function removeRow(button) {
				var table = document.getElementById("config_table");
				var rowIndex = button.parentNode.parentNode.rowIndex;
				var rowCount = table.rows.length;
				if (rowCount > 2) {
					table.deleteRow(rowIndex);
					update_command();
				}
			}

			function createTable() {
				var table = $("#config_table");
				var tbody = table.find("tbody");

				tableData.forEach(function(item) {
					var row = $("<tr>");
					var labelCell = $("<td>").text(item.label);
					var valueCell = $("<td>").attr("colspan", "2");

					if (item.type === "select") {
						var select = $("<select>").attr("id", item.id);
						$.each(item.options, function(index, option) {
							select.append($("<option></option>")
								.attr("value", option.value)
								.text(option.text));
						});
						valueCell.append(select);
					} else {
						var input = $("<input>").attr({ id: item.id, type: item.type, value: item.value, placeholder: item.placeholder, min: item.min, max: item.max });

						if (item.type === "checkbox") {
							input.prop("checked", item.value);
						}

						input.on({
							change: update_command,
							keyup: update_command,
							click: update_command
						});

						valueCell.append(input);
					}

					if (item.id !== "partition") {
						valueCell.append($(`<div class='error_element' id="${item.id}_error"></div>`));
					}

					row.append(labelCell, valueCell);
					tbody.append(row);
				});

				tbody.append("<tr><td colspan='3'><button onclick='addRow(this)' class='add_parameter' id='main_add_row_button'>Add Parameter</button></td></tr>");
			}

			function updateUrl() {
				var params = [];
				tableData.forEach(function(item) {
					params.push(item.id + "=" + $("#" + item.id).val());
				});

				var parameterIndex = 0;
				$(".parameterRow").each(function() {
					var option = $(this).find(".optionSelect").val();
					var parameterName = $(this).find(".parameterName").val();

					if(parameterName && !parameterName.match(/^\w+$/)) {
						console.error(`Parameter name "${parameterName}" does have invalid characters. Must be all letters.`)
					} else if (parameterName) {
						if (option === "range") {
							var minValue = $(this).find(".minValue").val();
							var maxValue = $(this).find(".maxValue").val();
							var numberType = $(this).find(".numberTypeSelect").val();

							params.push("parameter_" + parameterIndex + "_name=" + parameterName);
							params.push("parameter_" + parameterIndex + "_type=" + option);
							params.push("parameter_" + parameterIndex + "_min=" + minValue);
							params.push("parameter_" + parameterIndex + "_max=" + maxValue);
							params.push("parameter_" + parameterIndex + "_number_type=" + numberType);
						} else if (option === "choice") {
							var choiceValues = $(this).find(".choiceValues").val();

							params.push("parameter_" + parameterIndex + "_name=" + parameterName);
							params.push("parameter_" + parameterIndex + "_type=" + option);
							params.push("parameter_" + parameterIndex + "_values=" + choiceValues);
						} else if (option === "fixed") {
							var fixedValue = $(this).find(".fixedValue").val();

							params.push("parameter_" + parameterIndex + "_name=" + parameterName);
							params.push("parameter_" + parameterIndex + "_type=" + option);
							params.push("parameter_" + parameterIndex + "_value=" + fixedValue);
						}
					}
					parameterIndex++;
				});

				if (initialized) {
					var url = window.location.origin + window.location.pathname + "?" + params.join("&") + "&num_parameters=" + $(".parameterRow").length;
					try {
						window.history.replaceState(null, null, url);
					} catch (err) {
						err = "" + err;

						if(err.includes("The operation is insecure") && !shown_operation_insecure_without_server) {
							log(err);
							shown_operation_insecure_without_server = true;
						} else if (!err.includes("The operation is insecure")) {
							console.error(err);
						}
					}
				}
			}


			$(document).ready(function() {
				createTable();
				updatePartitionOptions();

				var urlParams = new URLSearchParams(window.location.search);
				tableData.forEach(function(item) {
					var paramValue = urlParams.get(item.id);
					if (paramValue !== null) {
						$("#" + item.id).val(paramValue).trigger('change');
					}
				});

				var num_parameters = urlParams.get("num_parameters");
				if (num_parameters) {
					for (var k = 0; k < num_parameters; k++) {
						$("#main_add_row_button").click();
					}
				} else {
					$("#main_add_row_button").click();
				}

				var parameterIndex = 0;
				$(".parameterRow").each(function(index) {
					var parameterName = urlParams.get("parameter_" + parameterIndex + "_name");
					var option = urlParams.get("parameter_" + parameterIndex + "_type");

					if (parameterName && option) {
						$(this).find(".parameterName").val(parameterName);
						$(this).find(".optionSelect").val(option).trigger('change');
						if (option === 'range') {
							$(this).find(".minValue").val(urlParams.get("parameter_" + parameterIndex + "_min"));
							$(this).find(".maxValue").val(urlParams.get("parameter_" + parameterIndex + "_max"));
							$(this).find(".numberTypeSelect").val(urlParams.get("parameter_" + parameterIndex + "_number_type"));
						} else if (option === 'choice') {
							$(this).find(".choiceValues").val(urlParams.get("parameter_" + parameterIndex + "_values"));
						} else if (option === 'fixed') {
							$(this).find(".fixedValue").val(urlParams.get("parameter_" + parameterIndex + "_value"));
						}
					}
					parameterIndex++;
				});

				update_command();

				initialized = true;
			});
		</script>
	</head>
	<body>
		<table>
			<tr>
				<td class='half_width_td'>
					<table id="config_table" border="1">
						<thead>
							<tr>
								<th>Option</th>
								<th colspan="2">Value</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</td>
				<td class='half_width_td'>
					<code id="command"></code>
					<div id="warnings" style="display: none"></div>
				</td>
			</tr>
		</table>
	</body>
</html>
